# =============================================================================
# DocQA-MS - Pipeline CD (Continuous Deployment)
# Build, Push Docker Images & Deploy
# =============================================================================

name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/docqa-ms

jobs:
  # ===========================================================================
  # Build and Push Docker Images
  # ===========================================================================
  build-and-push:
    name: ðŸ³ Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    strategy:
      fail-fast: false
      matrix:
        service: 
          - api-gateway
          - doc-ingestor
          - deid-service
          - indexeur-semantique
          # - llm-qa-module  # Excluded: takes too long to build with LLM model
          - synthese-comparative
          - audit-logger
          - interface-clinique
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

      - name: ðŸš€ Push Docker image (if authenticated)
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VERSION=${{ github.sha }}
        continue-on-error: true

  # ===========================================================================
  # Deploy to Staging (Simulation)
  # ===========================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always() && (github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'))
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up environment
        run: |
          echo "=============================================="
          echo "ðŸš€ STAGING DEPLOYMENT"
          echo "=============================================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "=============================================="

      - name: ðŸ“ Generate docker-compose for staging
        run: |
          cat > docker-compose.staging.yml << 'EOF'
          version: "3.8"
          services:
            api-gateway:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-api-gateway:main
              ports:
                - "8000:8000"
            doc-ingestor:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-doc-ingestor:main
              ports:
                - "8001:8001"
            deid-service:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-deid-service:main
              ports:
                - "8002:8002"
            indexeur-semantique:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-indexeur-semantique:main
              ports:
                - "8003:8003"
            llm-qa-module:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-llm-qa-module:main
              ports:
                - "8004:8004"
            synthese-comparative:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-synthese-comparative:main
              ports:
                - "8005:8005"
            audit-logger:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-audit-logger:main
              ports:
                - "8006:8006"
            interface-clinique:
              image: ghcr.io/${{ github.repository_owner }}/docqa-ms-interface-clinique:main
              ports:
                - "3000:80"
          EOF
          echo "âœ… docker-compose.staging.yml generated"

      - name: ðŸš€ Deploy simulation
        run: |
          echo ""
          echo "ðŸ“‹ Services to deploy:"
          echo "  âœ… API Gateway (port 8000)"
          echo "  âœ… Doc Ingestor (port 8001)"
          echo "  âœ… DeID Service (port 8002)"
          echo "  âœ… Indexeur SÃ©mantique (port 8003)"
          echo "  âœ… LLM QA Module (port 8004)"
          echo "  âœ… SynthÃ¨se Comparative (port 8005)"
          echo "  âœ… Audit Logger (port 8006)"
          echo "  âœ… Interface Clinique (port 3000)"
          echo ""
          echo "=============================================="
          echo "âœ… STAGING DEPLOYMENT COMPLETED!"
          echo "=============================================="

  # ===========================================================================
  # Deploy to Production (Only on tags)
  # ===========================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Production deployment
        run: |
          echo "=============================================="
          echo "ðŸš€ PRODUCTION DEPLOYMENT"
          echo "=============================================="
          echo "âš ï¸ This is a PRODUCTION deployment!"
          echo "Tag: ${{ github.ref_name }}"
          echo ""
          echo "ðŸ“‹ Rolling update strategy:"
          echo "  1. Deploy new containers"
          echo "  2. Health check"
          echo "  3. Switch traffic"
          echo "  4. Remove old containers"
          echo ""
          echo "âœ… Production deployment completed!"
          echo "=============================================="

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: always()
    
    steps:
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "=============================================="
          echo "ðŸ“Š CD PIPELINE SUMMARY"
          echo "=============================================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch/Tag: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Build & Push: ${{ needs.build-and-push.result }}"
          echo "Staging: ${{ needs.deploy-staging.result }}"
          echo "=============================================="
